/**
 * jQuery EasyUI 1.5.2
 * 
 * Copyright (c) 2009-2017 www.jeasyui.com. All rights reserved.
 *
 * Licensed under the freeware license: http://www.jeasyui.com/license_freeware.php
 * To use it on other terms please contact us: info@jeasyui.com
 *
 */
(function(b){function t(a){function c(c){return b(c).closest(".combo-panel").panel("options").comboTarget||a}function e(a){return function(q,e){var d=c(this),d=b(d).combogrid("options");"onUnselectAll"==a?d.multiple&&g.call(this):g.call(this);d[a].call(this,q,e)}}function g(){var a=b(this),d=c(a),e=b(d).data("combogrid"),g=e.options,a=b.map(a.datagrid("getSelections"),function(b){return b[g.idField]}),a=a.concat(g.unselectedValues);k(d,a,e.remainText)}var h=b.data(a,"combogrid"),f=h.options,d=h.grid;b(a).addClass("combogrid-f").combo(b.extend({},f,{onShowPanel:function(){k(this,b(this).combogrid("getValues"),!0);var a=b(this).combogrid("panel"),c=a.outerHeight()-a.height(),d=a._size("minHeight"),e=a._size("maxHeight"),a=b(this).combogrid("grid");a.datagrid("resize",{width:"100%",height:isNaN(parseInt(f.panelHeight))?"auto":"100%",minHeight:d?d-c:"",maxHeight:e?e-c:""});(c=a.datagrid("getSelected"))&&a.datagrid("scrollTo",a.datagrid("getRowIndex",c));f.onShowPanel.call(this)}}));var l=b(a).combo("panel");d||(d=b("\x3ctable\x3e\x3c/table\x3e").appendTo(l),h.grid=d);d.datagrid(b.extend({},f,{border:!1,singleSelect:!f.multiple,onLoadSuccess:function(a){var d=c(this),e=b(d).data("combogrid"),g=e.options,f=b(d).combo("getValues");k(d,f,e.remainText);g.onLoadSuccess.call(this,a)},onClickRow:function(a,d){var e=c(this),f=b(e).data("combogrid"),h=f.options;f.remainText=!1;g.call(this);h.multiple||b(e).combo("hidePanel");h.onClickRow.call(this,a,d)},onSelect:e("onSelect"),onUnselect:e("onUnselect"),onSelectAll:e("onSelectAll"),onUnselectAll:e("onUnselectAll")}))}function p(a,c){var e=b.data(a,"combogrid"),g=e.options,h=e.grid,f=h.datagrid("getRows").length;if(f){var d=g.finder.getTr(h[0],null,"highlight");d.length||(d=g.finder.getTr(h[0],null,"selected"));d.length?(d=parseInt(d.attr("datagrid-row-index")),d+="next"==c?1:-1,0>d&&(d=f-1),d>=f&&(d=0)):d="next"==c?0:f-1;h.datagrid("highlightRow",d);g.selectOnNavigation&&(e.remainText=!1,h.datagrid("selectRow",d))}}function k(a,c,e){function g(a,c){var d=b.easyui.getArrayItem(c,f.idField,a);return d?d[f.textField]:void 0}var h=b.data(a,"combogrid"),f=h.options,d=h.grid,h=b(a).combo("getValues"),l=b(a).combo("options"),q=l.onChange;l.onChange=function(){};var m=d.datagrid("options"),u=m.onSelect,k=m.onUnselectAll;m.onSelect=m.onUnselectAll=function(){};b.isArray(c)||(c=c.split(f.separator));f.multiple||(c=c.length?[c[0]]:[""]);var n=b.map(c,function(b){return String(b)}),n=b.grep(n,function(a,c){return c===b.inArray(a,n)}),p=b.grep(d.datagrid("getSelections"),function(a,c){return 0<=b.inArray(String(a[f.idField]),n)});d.datagrid("clearSelections");d.data("datagrid").selectedRows=p;var r=[];f.unselectedValues=[];b.map(n,function(a){var b=d.datagrid("getRowIndex",a);0<=b?d.datagrid("selectRow",b):f.unselectedValues.push(a);r.push(g(a,d.datagrid("getRows"))||g(a,p)||g(a,f.mappingRows)||a)});b(a).combo("setValues",h);l.onChange=q;m.onSelect=u;m.onUnselectAll=k;e||(e=r.join(f.separator),b(a).combo("getText")!=e&&b(a).combo("setText",e));b(a).combo("setValues",c)}function v(a,c){function e(a,b){for(var c=0;c<a.length;c++){var d=a[c];if((d[h.textField]||"").toLowerCase()==b.toLowerCase())return l.push(d[h.idField]),c}return-1}var g=b.data(a,"combogrid"),h=g.options,f=g.grid;g.remainText=!0;g=h.multiple?c.split(h.separator):[c];g=b.grep(g,function(a){return""!=b.trim(a)});if("remote"==h.mode)h.reversed||k(a,g,!0),f.datagrid("load",b.extend({},h.queryParams,{q:c}));else{f.datagrid("highlightRow",-1);var d=f.datagrid("getRows"),l=[];b.map(g,function(c){c=b.trim(c);e(h.mappingRows,c);e(f.datagrid("getSelections"),c);var g=e(d,c);0<=g?h.reversed&&f.datagrid("highlightRow",g):b.map(d,function(b,d){h.filter.call(a,c,b)&&f.datagrid("highlightRow",d)})});h.reversed||k(a,l,!0)}}function w(a){var c=b.data(a,"combogrid"),e=c.options,g=c.grid,h=e.finder.getTr(g[0],null,"highlight");c.remainText=!1;h.length&&(c=parseInt(h.attr("datagrid-row-index")),e.multiple?h.hasClass("datagrid-row-selected")?g.datagrid("unselectRow",c):g.datagrid("selectRow",c):g.datagrid("selectRow",c));var f=[];b.map(g.datagrid("getSelections"),function(a){f.push(a[e.idField])});b.map(e.unselectedValues,function(a){0<=b.easyui.indexOfArray(e.mappingRows,e.idField,a)&&b.easyui.addArrayItem(f,a)});b(a).combogrid("setValues",f);e.multiple||b(a).combogrid("hidePanel")}b.fn.combogrid=function(a,c){if("string"==typeof a){var e=b.fn.combogrid.methods[a];return e?e(this,c):this.combo(a,c)}a=a||{};return this.each(function(){var c=b.data(this,"combogrid");c?b.extend(c.options,a):b.data(this,"combogrid",{options:b.extend({},b.fn.combogrid.defaults,b.fn.combogrid.parseOptions(this),a)});t(this)})};b.fn.combogrid.methods={options:function(a){var c=a.combo("options");return b.extend(b.data(a[0],"combogrid").options,{width:c.width,height:c.height,originalValue:c.originalValue,disabled:c.disabled,readonly:c.readonly})},cloneFrom:function(a,c){return a.each(function(){b(this).combo("cloneFrom",c);b.data(this,"combogrid",{options:b.extend(!0,{cloned:!0},b(c).combogrid("options")),combo:b(this).next(),panel:b(c).combo("panel"),grid:b(c).combogrid("grid")})})},grid:function(a){return b.data(a[0],"combogrid").grid},setValues:function(a,c){return a.each(function(){var a=b(this).combogrid("options");b.isArray(c)&&(c=b.map(c,function(c){return c&&"object"==typeof c?(b.easyui.addArrayItem(a.mappingRows,a.idField,c),c[a.idField]):c}));k(this,c)})},setValue:function(a,c){return a.each(function(){b(this).combogrid("setValues",b.isArray(c)?c:[c])})},clear:function(a){return a.each(function(){b(this).combogrid("setValues",[])})},reset:function(a){return a.each(function(){var a=b(this).combogrid("options");a.multiple?b(this).combogrid("setValues",a.originalValue):b(this).combogrid("setValue",a.originalValue)})}};b.fn.combogrid.parseOptions=function(a){b(a);return b.extend({},b.fn.combo.parseOptions(a),b.fn.datagrid.parseOptions(a),b.parser.parseOptions(a,["idField","textField","mode"]))};b.fn.combogrid.defaults=b.extend({},b.fn.combo.defaults,b.fn.datagrid.defaults,{loadMsg:null,idField:null,textField:null,unselectedValues:[],mappingRows:[],mode:"local",keyHandler:{up:function(a){p(this,"prev");a.preventDefault()},down:function(a){p(this,"next");a.preventDefault()},left:function(a){},right:function(a){},enter:function(a){w(this)},query:function(a,b){v(this,a)}},inputEvents:b.extend({},b.fn.combo.defaults.inputEvents,{blur:function(a){a=a.data.target;b(a).combogrid("options").reversed&&b(a).combogrid("setValues",b(a).combogrid("getValues"))}}),filter:function(a,c){var e=b(this).combogrid("options");return 0<=(c[e.textField]||"").toLowerCase().indexOf(a.toLowerCase())}})})(jQuery);